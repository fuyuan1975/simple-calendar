<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>éƒ­å®¶è¡Œäº‹æ›†</title>
  
  <!-- PWA åŸºæœ¬è¨­å®š -->
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å®¶åº­è¡Œäº‹æ›†">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- å…§åµŒ Manifest -->
  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIuW6rOWutumrlOWFseS6q+ihjOS6i+abuCIsCiAgInNob3J0X25hbWUiOiAi6YO55a626KGM5LqL5piIIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJ0aGVtZV9jb2xvciI6ICIjMDA3YmZmIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyMzAwN2JmZicvJTNFJTNDdGV4dCB5PSc3MCcgZm9udC1zaXplPSc1MCcgZmlsbD0nd2hpdGUnIHRleHQtYW5jaG9yPSdtaWRkbGUnIHg9JzUwJyUzRSVFOSU4MyU5NSVFNSU5MCU4RCVFNSU5QyU5MyUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyMzAwN2JmZicvJTNFJTNDdGV4dCB5PSc3MCcgZm9udC1zaXplPSc1MCcgZmlsbD0nd2hpdGUnIHRleHQtYW5jaG9yPSdtaWRkbGUnIHg9JzUwJyUzRSVFOSU4MyU5NSVFNSU5MCU4RCVFNSU5QyU5MyUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
  
  <!-- Firebase SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
  
  <!-- åœ–ç¤ºè¨­å®š -->
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23007bff'/%3E%3Ctext y='70' font-size='50' fill='white' text-anchor='middle' x='50'%3Eéƒ­%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23007bff'/%3E%3Ctext y='70' font-size='50' fill='white' text-anchor='middle' x='50'%3Eéƒ­%3C/text%3E%3C/svg%3E">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      padding: 20px;
    }
    
    .calendar-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    /* å®¶äººé¸æ“‡å™¨ */
    .family-selector {
      background: #f8f9fa;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #dee2e6;
    }
    
    .family-member {
      display: inline-block;
      margin: 5px;
      padding: 8px 15px;
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .family-member.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    
    .family-member:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .calendar-header {
      background: #007bff;
      color: white;
      padding: 20px;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .nav-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 10px;
      border-radius: 4px;
    }
    
    .nav-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    
    .day-header {
      background: #f8f9fa;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      border: 1px solid #dee2e6;
    }
    
    .calendar-day {
      min-height: 100px;
      border: 1px solid #dee2e6;
      padding: 8px;
      cursor: pointer;
      position: relative;
    }
    
    .calendar-day:hover {
      background: #f8f9fa;
    }
    
    .calendar-day.other-month {
      background: #f8f9fa;
      color: #6c757d;
    }
    
    .calendar-day.today {
      background: #e3f2fd;
      font-weight: bold;
    }
    
    .day-number {
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .event {
      color: white;
      padding: 2px 6px;
      margin: 2px 0;
      border-radius: 3px;
      font-size: 12px;
      cursor: pointer;
      word-wrap: break-word;
    }
    
    .event:hover {
      opacity: 0.8;
    }
    
    /* äº‹ä»¶é¡è‰²ä¾å®¶äººå€åˆ† */
    .event.dad { background: #007bff; }
    .event.mom { background: #e91e63; }
    .event.child1 { background: #ff9800; }
    .event.child2 { background: #4caf50; }
    .event.family { background: #9c27b0; }
    
    /* æ¨¡æ…‹æ¡† */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: black;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    
    .btn:hover {
      background: #0056b3;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .controls {
      text-align: center;
      padding: 15px;
      background: #f8f9fa;
      position: relative;
    }
    
    /* PWA å®‰è£æç¤º */
    .install-banner {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 10px 15px;
      text-align: center;
      display: none;
      position: relative;
      animation: slideDown 0.5s ease-out;
    }
    
    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .install-banner button {
      background: white;
      color: #28a745;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      margin: 0 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .install-banner button:hover {
      background: #f8f9fa;
    }
    
    .install-banner .close-banner {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      color: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="calendar-container">
    <!-- PWA å®‰è£æç¤ºæ©«å¹… -->
    <div id="installBanner" class="install-banner">
      <span>ğŸ“± å¯ä»¥å®‰è£åˆ°æ‰‹æ©Ÿä¸»ç•«é¢ï¼</span>
      <button onclick="showInstallGuide()">æŸ¥çœ‹å®‰è£æŒ‡å—</button>
      <button onclick="hideInstallBanner()">ä¸ç”¨äº†</button>
      <button class="close-banner" onclick="hideInstallBanner()">&times;</button>
    </div>
    
    <!-- å®¶äººé¸æ“‡å™¨ -->
    <div class="family-selector">
      <div style="margin-bottom: 10px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ é¸æ“‡å®¶åº­æˆå“¡ï¼š</div>
      <span class="family-member active" onclick="selectFamily('all')" id="btn-all">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å…¨å®¶</span>
      <span class="family-member" onclick="selectFamily('dad')" id="btn-dad">ğŸ‘¨ çˆ¸çˆ¸</span>
      <span class="family-member" onclick="selectFamily('mom')" id="btn-mom">ğŸ‘© åª½åª½</span>
      <span class="family-member" onclick="selectFamily('child1')" id="btn-child1">ğŸ§’ ç§‰ç¿°</span>
      <span class="family-member" onclick="selectFamily('child2')" id="btn-child2">ğŸ‘¶ å®¥æ¬£</span>
      <span class="family-member" onclick="selectFamily('family')" id="btn-family">ğŸ  å®¶åº­æ´»å‹•</span>
    </div>
    
    <div class="controls">
      <button class="btn" onclick="showModal()">æ–°å¢äº‹ä»¶</button>
      <button class="btn" onclick="syncWithFirebase()" id="syncBtn">ğŸ”„ åŒæ­¥</button>
      <div id="syncStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
    </div>
    
    <div class="calendar-header">
      <button class="nav-btn" onclick="changeMonth(-1)">â€¹</button>
      <h2 id="monthYear"></h2>
      <button class="nav-btn" onclick="changeMonth(1)">â€º</button>
    </div>
    
    <div class="calendar-grid">
      <div class="day-header">æ—¥</div>
      <div class="day-header">ä¸€</div>
      <div class="day-header">äºŒ</div>
      <div class="day-header">ä¸‰</div>
      <div class="day-header">å››</div>
      <div class="day-header">äº”</div>
      <div class="day-header">å…­</div>
    </div>
    
    <div class="calendar-grid" id="calendar"></div>
  </div>

  <!-- æ¨¡æ…‹æ¡† -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="hideModal()">&times;</span>
      <h3 id="modalTitle">æ–°å¢äº‹ä»¶</h3>
      
      <div class="form-group">
        <label>äº‹ä»¶æ¨™é¡Œï¼š</label>
        <input type="text" id="eventTitle">
      </div>
      
      <div class="form-group">
        <label>æ—¥æœŸï¼š</label>
        <input type="date" id="eventDate">
      </div>
      
      <div class="form-group">
        <label>æ™‚é–“ï¼š</label>
        <input type="time" id="eventTime" value="09:00">
      </div>
      
      <div class="form-group">
        <label>å±¬æ–¼èª°ï¼š</label>
        <select id="eventMember">
          <option value="dad">ğŸ‘¨ çˆ¸çˆ¸</option>
          <option value="mom">ğŸ‘© åª½åª½</option>
          <option value="child1">ğŸ§’ ç§‰ç¿°</option>
          <option value="child2">ğŸ‘¶ å®¥æ¬£</option>
          <option value="family">ğŸ  å®¶åº­æ´»å‹•</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>æè¿°ï¼š</label>
        <textarea id="eventDesc" rows="3"></textarea>
      </div>
      
      <button class="btn" onclick="saveEvent()">å„²å­˜</button>
      <button class="btn" onclick="hideModal()">å–æ¶ˆ</button>
      <button class="btn btn-danger" id="deleteBtn" style="display:none;">åˆªé™¤</button>
    </div>
  </div>

  <script>
    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyDqxxmcX5TR6Ylc8dtxxaAc1FXt3p57QAE",
      authDomain: "family-calendar-5bb01.firebaseapp.com",
      projectId: "family-calendar-5bb01",
      storageBucket: "family-calendar-5bb01.firebasestorage.app",
      messagingSenderId: "7720815747710",
      appId: "1:7720815747710:web:cfafa8b55b66ed6b428997",
      measurementId: "G-09E9WSSPC6"
    };
    
    // å…¨åŸŸè®Šæ•¸
    let currentDate = new Date();
    let events = [];
    let editingEvent = null;
    let currentFilter = 'all';
    let deferredPrompt; // PWA å®‰è£æç¤º
    let db = null; // Firebase Firestore è³‡æ–™åº«
    let isFirebaseEnabled = false;
    
    // åˆå§‹åŒ– Firebase
    function initFirebase() {
      try {
        // æª¢æŸ¥é…ç½®æ˜¯å¦å·²è¨­å®š
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
          console.log('Firebase é…ç½®å°šæœªè¨­å®šï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
          updateSyncStatus('æœ¬åœ°æ¨¡å¼ - éœ€è¦è¨­å®š Firebase');
          return false;
        }
        
        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        isFirebaseEnabled = true;
        
        console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
        updateSyncStatus('å·²é€£æ¥é›²ç«¯è³‡æ–™åº«');
        
        // è¼‰å…¥é›²ç«¯äº‹ä»¶
        loadEventsFromFirebase();
        
        // ç›£è½å³æ™‚æ›´æ–°
        setupRealtimeListener();
        
        return true;
      } catch (error) {
        console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
        updateSyncStatus('é›²ç«¯é€£æ¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
        return false;
      }
    }
    
    // æ›´æ–°åŒæ­¥ç‹€æ…‹
    function updateSyncStatus(message) {
      const statusEl = document.getElementById('syncStatus');
      if (statusEl) {
        statusEl.textContent = message;
      }
    }
    
    // å¾ Firebase è¼‰å…¥äº‹ä»¶
    async function loadEventsFromFirebase() {
      if (!isFirebaseEnabled) return;
      
      try {
        updateSyncStatus('æ­£åœ¨è¼‰å…¥äº‹ä»¶...');
        const snapshot = await db.collection('familyEvents').get();
        const cloudEvents = [];
        
        snapshot.forEach(doc => {
          cloudEvents.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        events = cloudEvents;
        renderCalendar();
        updateSyncStatus(`å·²è¼‰å…¥ ${events.length} å€‹äº‹ä»¶`);
        console.log('å¾é›²ç«¯è¼‰å…¥äº‹ä»¶:', events.length);
      } catch (error) {
        console.error('è¼‰å…¥äº‹ä»¶å¤±æ•—:', error);
        updateSyncStatus('è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
      }
    }
    
    // è¨­ç½®å³æ™‚ç›£è½
    function setupRealtimeListener() {
      if (!isFirebaseEnabled) return;
      
      db.collection('familyEvents').onSnapshot((snapshot) => {
        console.log('æ”¶åˆ°å³æ™‚æ›´æ–°');
        const cloudEvents = [];
        
        snapshot.forEach(doc => {
          cloudEvents.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        events = cloudEvents;
        renderCalendar();
        updateSyncStatus(`å³æ™‚åŒæ­¥ - ${events.length} å€‹äº‹ä»¶`);
      }, (error) => {
        console.error('å³æ™‚ç›£è½éŒ¯èª¤:', error);
        updateSyncStatus('åŒæ­¥ä¸­æ–·ï¼Œè«‹é‡æ–°æ•´ç†');
      });
    }
    
    // å„²å­˜äº‹ä»¶åˆ° Firebase
    async function saveEventToFirebase(event) {
      if (!isFirebaseEnabled) return;
      
      try {
        await db.collection('familyEvents').doc(event.id).set({
          title: event.title,
          date: event.date,
          time: event.time,
          desc: event.desc,
          member: event.member,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('äº‹ä»¶å·²å„²å­˜åˆ°é›²ç«¯:', event.title);
      } catch (error) {
        console.error('å„²å­˜äº‹ä»¶å¤±æ•—:', error);
        updateSyncStatus('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }
    
    // å¾ Firebase åˆªé™¤äº‹ä»¶
    async function deleteEventFromFirebase(eventId) {
      if (!isFirebaseEnabled) return;
      
      try {
        await db.collection('familyEvents').doc(eventId).delete();
        console.log('äº‹ä»¶å·²å¾é›²ç«¯åˆªé™¤:', eventId);
      } catch (error) {
        console.error('åˆªé™¤äº‹ä»¶å¤±æ•—:', error);
        updateSyncStatus('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }
    
    // æ‰‹å‹•åŒæ­¥
    async function syncWithFirebase() {
      if (!isFirebaseEnabled) {
        alert('Firebase å°šæœªè¨­å®šï¼Œè«‹å…ˆè¨­å®šé›²ç«¯è³‡æ–™åº«é…ç½®');
        return;
      }
      
      updateSyncStatus('æ­£åœ¨åŒæ­¥...');
      await loadEventsFromFirebase();
    }
    
    // PWA ç›¸é—œåŠŸèƒ½
    window.addEventListener('load', () => {
      console.log('é é¢è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ– PWA åŠŸèƒ½');
      
      // æª¢æŸ¥æ˜¯å¦æ”¯æ´ PWA
      if ('serviceWorker' in navigator) {
        console.log('æ”¯æ´ Service Worker');
        // ä¸è¨»å†Š Service Workerï¼Œé¿å…å•é¡Œ
      }
      
      // ç›£è½ PWA å®‰è£æç¤ºäº‹ä»¶
      window.addEventListener('beforeinstallprompt', (e) => {
        console.log('PWA å®‰è£æç¤ºäº‹ä»¶è§¸ç™¼');
        e.preventDefault();
        deferredPrompt = e;
        showInstallBanner();
      });
      
      // ç›£è½ PWA å®‰è£æˆåŠŸäº‹ä»¶
      window.addEventListener('appinstalled', (e) => {
        console.log('PWA å®‰è£æˆåŠŸ');
        hideInstallBanner();
        alert('ğŸ‰ å®¶åº­è¡Œäº‹æ›†å·²æˆåŠŸå®‰è£åˆ°æ‚¨çš„è£ç½®ï¼');
      });
      
      // å¦‚æœæ²’æœ‰è‡ªå‹•è§¸ç™¼å®‰è£æç¤ºï¼Œå»¶é²é¡¯ç¤ºæ‰‹å‹•å®‰è£æ©«å¹…
      checkShowInstallBanner();
    });
    
    // é¡¯ç¤ºå®‰è£æ©«å¹…
    function showInstallBanner() {
      const banner = document.getElementById('installBanner');
      if (banner) {
        banner.style.display = 'block';
        console.log('é¡¯ç¤ºå®‰è£æ©«å¹…');
      }
    }
    
    // éš±è—å®‰è£æ©«å¹…
    function hideInstallBanner() {
      const banner = document.getElementById('installBanner');
      if (banner) {
        banner.style.display = 'none';
        console.log('éš±è—å®‰è£æ©«å¹…');
      }
    }
    
    // é¡¯ç¤ºå®‰è£æŒ‡å—
    function showInstallGuide() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);
      
      let guide = 'ğŸ“± æ‰‹å‹•å®‰è£æ­¥é©Ÿï¼š\n\n';
      
      if (isIOS) {
        guide += 'ğŸ iPhone/iPadï¼š\n';
        guide += '1. é»æ“Šä¸‹æ–¹çš„ã€Œåˆ†äº«ã€æŒ‰éˆ• ğŸ“¤\n';
        guide += '2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n';
        guide += '3. ç¢ºèªå®‰è£\n';
        guide += '4. åœ¨ä¸»ç•«é¢å°±æœƒå‡ºç¾è¡Œäº‹æ›†åœ–ç¤ºï¼';
      } else if (isAndroid) {
        guide += 'ğŸ¤– Androidï¼š\n';
        guide += '1. é»æ“Šç€è¦½å™¨é¸å–® â‹®\n';
        guide += '2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€æˆ–ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€\n';
        guide += '3. ç¢ºèªå®‰è£\n';
        guide += '4. åœ¨ä¸»ç•«é¢å°±æœƒå‡ºç¾è¡Œäº‹æ›†åœ–ç¤ºï¼';
      } else {
        guide += 'ğŸ’» é›»è…¦ç‰ˆï¼š\n';
        guide += '1. é»æ“Šç¶²å€åˆ—å³å´çš„ã€Œå®‰è£ã€åœ–ç¤º\n';
        guide += '2. æˆ–åœ¨ç€è¦½å™¨é¸å–®ä¸­é¸æ“‡ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€\n';
        guide += '3. ç¢ºèªå®‰è£';
      }
      
      guide += '\n\nå®‰è£å¾Œå°±å¯ä»¥åƒçœŸçš„ APP ä¸€æ¨£ä½¿ç”¨ï¼';
      alert(guide);
      hideInstallBanner();
    }
    
    // å®‰è£ PWA
    function installPWA() {
      console.log('ç”¨æˆ¶é»æ“Šå®‰è£ PWA');
      
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          console.log('ç”¨æˆ¶é¸æ“‡:', choiceResult.outcome);
          if (choiceResult.outcome === 'accepted') {
            console.log('ç”¨æˆ¶æ¥å—å®‰è£');
          } else {
            console.log('ç”¨æˆ¶æ‹’çµ•å®‰è£');
          }
          deferredPrompt = null;
          hideInstallBanner();
        });
      } else {
        // é¡¯ç¤ºæ‰‹å‹•å®‰è£æŒ‡å—
        showInstallGuide();
      }
    }
    
    // æª¢æŸ¥æ˜¯å¦æ‡‰è©²é¡¯ç¤ºå®‰è£æ©«å¹…
    function checkShowInstallBanner() {
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯ PWA æ¨¡å¼
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
      const isInWebApp = window.navigator.standalone; // iOS
      
      if (!isStandalone && !isInWebApp) {
        // å»¶é²é¡¯ç¤ºï¼Œè®“ç”¨æˆ¶å…ˆé«”é©—åŠŸèƒ½
        setTimeout(() => {
          showInstallBanner();
        }, 5000); // 5ç§’å¾Œé¡¯ç¤º
      }
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // å–å¾—æœˆä»½åç¨±
    function getMonthName(date) {
      const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 
                     '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
      return `${date.getFullYear()}å¹´ ${months[date.getMonth()]}`;
    }
    
    // åˆå§‹åŒ–
    function init() {
      // åˆå§‹åŒ–ç©ºçš„äº‹ä»¶é™£åˆ—
      events = [];
      
      // åˆå§‹åŒ– Firebase
      initFirebase();
      
      renderCalendar();
    }
    
    // é¸æ“‡å®¶åº­æˆå“¡
    function selectFamily(member) {
      currentFilter = member;
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.family-member').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`btn-${member}`).classList.add('active');
      
      // é‡æ–°æ¸²æŸ“è¡Œäº‹æ›†
      renderCalendar();
    }
    
    // æ¸²æŸ“è¡Œäº‹æ›†
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // æ›´æ–°æ¨™é¡Œ
      document.getElementById('monthYear').textContent = getMonthName(currentDate);
      
      // è¨ˆç®—æœˆä»½ç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
      
      const today = formatDate(new Date());
      
      // ç”¢ç”Ÿæ—¥æœŸæ ¼å­
      for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const dateStr = formatDate(date);
        
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        if (date.getMonth() !== month) {
          dayDiv.classList.add('other-month');
        }
        
        if (dateStr === today) {
          dayDiv.classList.add('today');
        }
        
        dayDiv.innerHTML = `<div class="day-number">${date.getDate()}</div>`;
        dayDiv.onclick = () => selectDate(dateStr);
        
        // æ·»åŠ äº‹ä»¶ï¼ˆæ ¹æ“šç¯©é¸æ¢ä»¶ï¼‰
        const dayEvents = events.filter(event => {
          const matchDate = event.date === dateStr;
          const matchMember = currentFilter === 'all' || event.member === currentFilter;
          return matchDate && matchMember;
        });
        
        dayEvents.forEach(event => {
          const eventDiv = document.createElement('div');
          eventDiv.className = `event ${event.member}`;
          eventDiv.textContent = event.title;
          eventDiv.onclick = (e) => {
            e.stopPropagation();
            editEvent(event);
          };
          dayDiv.appendChild(eventDiv);
        });
        
        calendar.appendChild(dayDiv);
      }
    }
    
    // é¸æ“‡æ—¥æœŸ
    function selectDate(date) {
      document.getElementById('eventDate').value = date;
      showModal();
    }
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    function showModal() {
      editingEvent = null;
      document.getElementById('modalTitle').textContent = 'æ–°å¢äº‹ä»¶';
      document.getElementById('deleteBtn').style.display = 'none';
      document.getElementById('eventTitle').value = '';
      document.getElementById('eventDesc').value = '';
      document.getElementById('eventTime').value = '09:00';
      document.getElementById('eventMember').value = 'family';
      document.getElementById('modal').style.display = 'block';
    }
    
    // éš±è—æ¨¡æ…‹æ¡†
    function hideModal() {
      document.getElementById('modal').style.display = 'none';
      editingEvent = null;
      console.log('æ¨¡æ…‹æ¡†å·²é—œé–‰ï¼ŒeditingEvent å·²æ¸…ç©º');
    }
    
    // ç·¨è¼¯äº‹ä»¶
    function editEvent(event) {
      console.log('é–‹å§‹ç·¨è¼¯äº‹ä»¶:', event);
      editingEvent = event;
      
      document.getElementById('modalTitle').textContent = 'ç·¨è¼¯äº‹ä»¶';
      
      // é‡æ–°ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
      const deleteBtn = document.getElementById('deleteBtn');
      deleteBtn.style.display = 'inline-block';
      deleteBtn.onclick = function() {
        console.log('åˆªé™¤æŒ‰éˆ•è¢«é»æ“Šäº†ï¼');
        deleteEvent();
      };
      
      document.getElementById('eventTitle').value = event.title;
      document.getElementById('eventDate').value = event.date;
      document.getElementById('eventTime').value = event.time;
      document.getElementById('eventDesc').value = event.desc || '';
      document.getElementById('eventMember').value = event.member || 'family';
      document.getElementById('modal').style.display = 'block';
      
      console.log('editingEvent å·²è¨­ç½®ç‚º:', editingEvent);
    }
    
    // å„²å­˜äº‹ä»¶
    function saveEvent() {
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const time = document.getElementById('eventTime').value;
      const desc = document.getElementById('eventDesc').value.trim();
      const member = document.getElementById('eventMember').value;
      
      if (!title) {
        alert('è«‹è¼¸å…¥äº‹ä»¶æ¨™é¡Œ');
        return;
      }
      
      if (!date) {
        alert('è«‹é¸æ“‡æ—¥æœŸ');
        return;
      }
      
      if (editingEvent) {
        // ç·¨è¼¯ç¾æœ‰äº‹ä»¶
        editingEvent.title = title;
        editingEvent.date = date;
        editingEvent.time = time;
        editingEvent.desc = desc;
        editingEvent.member = member;
        
        // å„²å­˜åˆ° Firebase
        saveEventToFirebase(editingEvent);
      } else {
        // æ–°å¢äº‹ä»¶
        const newEvent = {
          id: Date.now().toString(),
          title: title,
          date: date,
          time: time,
          desc: desc,
          member: member
        };
        
        events.push(newEvent);
        
        // å„²å­˜åˆ° Firebase
        saveEventToFirebase(newEvent);
      }
      
      renderCalendar();
      hideModal();
    }
    
    // åˆªé™¤äº‹ä»¶
    function deleteEvent() {
      console.log('deleteEvent å‡½æ•¸è¢«å‘¼å«äº†ï¼');
      console.log('editingEvent:', editingEvent);
      
      if (!editingEvent) {
        console.log('éŒ¯èª¤: editingEvent ç‚ºç©º');
        alert('æ²’æœ‰é¸æ“‡è¦åˆªé™¤çš„äº‹ä»¶');
        return;
      }
      
      // å®‰å…¨åœ°å–å¾—äº‹ä»¶æ¨™é¡Œ
      const eventTitle = editingEvent.title || 'æœªå‘½åäº‹ä»¶';
      console.log('æº–å‚™åˆªé™¤äº‹ä»¶:', eventTitle);
      
      // ç›´æ¥åˆªé™¤ï¼Œä¸ä½¿ç”¨æœ‰å•é¡Œçš„ confirm()
      console.log('é–‹å§‹åˆªé™¤ç¨‹åº');
      console.log('åˆªé™¤å‰äº‹ä»¶æ•¸é‡:', events.length);
      console.log('è¦åˆªé™¤çš„äº‹ä»¶ID:', editingEvent.id);
      
      // å¾æœ¬åœ°é™£åˆ—ä¸­åˆªé™¤
      const originalLength = events.length;
      events = events.filter(e => e.id !== editingEvent.id);
      
      console.log('åˆªé™¤å¾Œäº‹ä»¶æ•¸é‡:', events.length);
      console.log('åˆªé™¤æˆåŠŸ:', events.length < originalLength);
      
      // å¾ Firebase åˆªé™¤
      deleteEventFromFirebase(editingEvent.id);
      
      // å…ˆé—œé–‰æ¨¡æ…‹æ¡†ï¼Œæ¸…ç©º editingEvent
      hideModal();
      
      // é‡æ–°æ¸²æŸ“
      renderCalendar();
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      alert(`äº‹ä»¶ã€Œ${eventTitle}ã€å·²åˆªé™¤ï¼`);
    }
    
    // åˆ‡æ›æœˆä»½
    function changeMonth(direction) {
      currentDate.setMonth(currentDate.getMonth() + direction);
      renderCalendar();
    }
    
    // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
    window.onclick = function(event) {
      const modal = document.getElementById('modal');
      if (event.target === modal) {
        hideModal();
      }
    }
    
    // å•Ÿå‹•
    init();
  </script>
</body>
</html>